<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pirate Escape - 2 Player Adventure</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a2e;
            color: #f8f8f2;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #lobby {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            background: url('/static/images/parchment_map.png') no-repeat center center;
            background-size: cover;
            border: 5px solid #8b4513;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        }

        h1, h2 {
            font-family: 'Pirata One', cursive;
            color: #8b4513;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
        }

        .room-input {
            padding: 10px;
            margin: 10px;
            width: 200px;
            background-color: #f8f8f2;
            border: 2px solid #8b4513;
            border-radius: 5px;
            color: #1a1a2e;
            font-family: 'Courier New', monospace;
        }

        button {
            background-color: #8b4513;
            color: #f8f8f2;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 5px;
            box-shadow: 0 4px #5a2e0c;
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: #a0522d;
            box-shadow: 0 6px #5a2e0c;
            transform: translateY(-2px);
        }

        button:active {
            box-shadow: 0 2px #5a2e0c;
            transform: translateY(2px);
        }

        #game-container {
            display: none;
            height: 100%;
            grid-template-columns: 1fr 300px;
            grid-template-rows: auto 1fr 200px;
        }

        #header {
            grid-column: 1 / 3;
            background-color: #16213e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #game-view {
            background-color: #0f3460;
            position: relative;
            overflow: hidden;
        }

        #inventory {
            background-color: #16213e;
            padding: 10px;
            overflow-y: auto;
        }

        #chat {
            grid-column: 1 / 3;
            background-color: #0f3460;
            border-top: 2px solid #e94560;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        #chat-form {
            display: flex;
            padding: 10px;
        }

        #chat-input {
            flex-grow: 1;
            padding: 8px;
            background-color: #1a1a2e;
            border: 1px solid #e94560;
            color: white;
        }

        .room-input {
            padding: 10px;
            margin: 10px;
            width: 200px;
            background-color: #f8f8f2;
            border: 2px solid #8b4513;
            border-radius: 5px;
            color: #1a1a2e;
            font-family: 'Courier New', monospace;
        }

        .game-object {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s;
            background-color: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 3px;
        }

        .game-object:hover {
            transform: scale(1.05);
            background-color: rgba(233, 69, 96, 0.5);
        }

        .inventory-item {
            background-color: #1a1a2e;
            padding: 8px;
            margin: 5px 0;
            cursor: pointer;
            border: 1px solid #e94560;
        }

        .inventory-item:hover {
            background-color: #e94560;
        }

        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
            background-color: #1a1a2e;
        }

        .player-1 {
            color: #4cc9f0;
        }

        .player-2 {
            color: #f72585;
        }

        #player-role {
            font-weight: bold;
            color: #e94560;
        }

        #room-code {
            font-family: monospace;
            letter-spacing: 2px;
            background-color: #1a1a2e;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .progress-bar {
            height: 10px;
            background-color: #1a1a2e;
            margin: 10px 0;
            border-radius: 5px;
            overflow: hidden;
            width: 200px;
        }
        
        .progress {
            height: 100%;
            background-color: #e94560;
            width: 0%;
            transition: width 0.5s;
        }
        
        .puzzle-hint {
            background-color: #16213e;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #e94560;
        }

        .scene-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #hint-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #16213e;
            padding: 20px;
            border: 3px solid #e94560;
            z-index: 100;
            max-width: 80%;
        }

        #hint-popup h3 {
            margin-top: 0;
            color: #e94560;
        }

        #close-hint {
            margin-top: 10px;
        }

        .combined-object {
            position: absolute;
            cursor: pointer;
            background-color: rgba(79, 192, 240, 0.5);
            padding: 5px;
            border-radius: 3px;
        }

        #player1-scene .scene-bg {
            background: url('/static/images/study_room.png') no-repeat center center;
            background-size: cover;
        }

        #player2-scene .scene-bg {
            background: url('/static/images/lab_basement.png') no-repeat center center;
            background-size: cover;
        }

        #audio-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #audio-controls input[type="range"] {
            width: 100px;
        }

        @media (max-width: 768px) {
            #game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }

            #inventory {
                grid-row: 3;
            }

            #chat {
                grid-row: 2;
            }
        }

        #next-room {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #16213e;
            padding: 20px;
            border: 3px solid #e94560;
            z-index: 100;
            max-width: 80%;
            color: #f8f8f2;
            text-align: center;
        }

        #next-room h1 {
            margin-top: 0;
            color: #e94560;
        }

        #next-room button {
            margin-top: 10px;
            background-color: #e94560;
            color: #1a1a2e;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        #next-room button:hover {
            background-color: #d03447;
        }
    </style>
</head>
<body>
    <!-- Lobby Screen -->
    <div id="lobby">
        <h1>Pirate Escape</h1>
        <p>A 2-player cooperative adventure</p>

        <div id="create-game" class="lobby-section">
            <h2>Create Game</h2>
            <input type="text" id="player1-name" class="room-input" placeholder="Your Name">
            <button id="create-btn">Create Room</button>
        </div>

        <div id="join-game" class="lobby-section">
            <h2>Join Game</h2>
            <input type="text" id="player2-name" class="room-input" placeholder="Your Name">
            <input type="text" id="room-id" class="room-input" placeholder="Room Code">
            <button id="join-btn">Join Room</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-container">
        <div id="header">
            <div>
                <span id="player-role">First Mate</span> | 
                Room: <span id="room-code-display">AAAA</span>
                <div class="progress-bar">
                    <div class="progress" id="game-progress"></div>
                </div>
            </div>
            <div>
                <button id="hint-btn">Hint</button>
                <button id="leave-btn">Leave Game</button>
            </div>
        </div>

        <div id="game-view">
            <!-- Player 1 sees the ship deck -->
            <div id="player1-scene" class="scene" style="display: none;">
                <img src="https://placeholder.pics/svg/800x600/DEDEDE/555555/Ship%20Deck" alt="Ship Deck" class="scene-bg">
                <div class="game-object" style="top: 200px; left: 100px;" data-object="chest">Treasure Chest</div>
                <div class="game-object" style="top: 300px; left: 400px;" data-object="wheel">Ship's Wheel</div>
                <div class="game-object" style="top: 150px; left: 600px;" data-object="telescope">Telescope</div>
                <div class="game-object" style="top: 400px; left: 200px; display: none;" data-object="log">Ship's Log</div>
                <div class="game-object" style="top: 250px; left: 500px; display: none;" data-object="lever">Mysterious Lever</div>
            </div>

            <!-- Player 2 sees the island beach -->
            <div id="player2-scene" class="scene" style="display: none;">
                <img src="https://placeholder.pics/svg/800x600/DEDEDE/555555/Island%20Beach" alt="Island Beach" class="scene-bg">
                <div class="game-object" style="top: 250px; left: 150px;" data-object="palm">Palm Tree</div>
                <div class="game-object" style="top: 350px; left: 450px;" data-object="cave">Cave Entrance</div>
                <div class="game-object" style="top: 200px; left: 650px;" data-object="map">Strange Markings</div>
                <div class="game-object" style="top: 500px; left: 300px; display: none;" data-object="bridge">Wooden Bridge</div>
                <div class="game-object" style="top: 400px; left: 200px; display: none;" data-object="artifact">Golden Artifact</div>
            </div>
        </div>

        <div id="inventory">
            <h3>Inventory</h3>
            <div id="inventory-items">
                <!-- Items will be added dynamically -->
            </div>
            <div class="puzzle-hint" id="current-hint">
                <h4>Current Objective</h4>
                <p id="hint-text">Find a way to open the treasure chest.</p>
            </div>
        </div>

        <div id="chat">
            <div id="messages"></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="Type your message...">
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <!-- Hint Popup -->
    <div id="hint-popup">
        <h3>Need a Hint?</h3>
        <div id="hint-content"></div>
        <button id="close-hint">Close</button>
    </div>

    <!-- Next Room Section -->
    <div id="next-room">
        <h1>Welcome to the Next Room</h1>
        <p>Continue your adventure and solve the next set of puzzles!</p>
        <button id="start-next-room">Start</button>
    </div>

    <div id="audio-controls">
        <label for="volume">Volume:</label>
        <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5">
        <button id="mute-toggle">Mute</button>
    </div>

    <script src="../static/js/animations.js"></script>
    <script>
        // Game State
        const gameState = {
            player: null,
            roomId: null,
            playerName: null,
            partnerName: null,
            inventory: [],
            progress: 0,
            currentStage: 1,
            stages: [
                {
                    name: "The Study and the Lab",
                    player1Goal: "Search Alistair's study for clues about his death and the mysterious Eternalis substance.",
                    player2Goal: "Investigate the lab for evidence of Blackwood's experiments and the truth about Eternalis.",
                    player1Hint: "Check the desk and the torn portrait for hidden compartments.",
                    player2Hint: "Look at the chalkboard and the shelves for anything unusual.",
                    completed: false,
                    triggers: {
                        deskExamined: false,
                        chalkboardExamined: false
                    }
                },
                {
                    name: "The Secret Library and Security Room",
                    player1Goal: "Find a way to open the hidden library behind the bookshelf.",
                    player2Goal: "Unlock the safe in the security room to access the CCTV footage.",
                    player1Hint: "The bookshelf might move if you find the right mechanism.",
                    player2Hint: "The safe requires a numeric code. Check the lab for clues.",
                    completed: false,
                    triggers: {
                        libraryOpened: false,
                        safeUnlocked: false
                    }
                },
                {
                    name: "The Great Hall",
                    player1Goal: "Meet Detective B in the Great Hall to solve the final mystery.",
                    player2Goal: "Meet Detective A in the Great Hall to solve the final mystery.",
                    player1Hint: "The hall is at the center of the mansion. Look for a grand staircase.",
                    player2Hint: "The hall is at the center of the mansion. Look for a grand staircase.",
                    completed: false,
                    triggers: {
                        hallReached: false
                    }
                }
            ],
            combinedItems: {
                "key_and_diary": {
                    items: ["study_key", "blackwood_diary"],
                    result: "The key unlocks a hidden compartment in the diary, revealing a map to the library.",
                    newItem: "library_map"
                }
            }
        };

        // DOM elements
        const lobby = document.getElementById('lobby');
        const gameContainer = document.getElementById('game-container');
        const createBtn = document.getElementById('create-btn');
        const joinBtn = document.getElementById('join-btn');
        const leaveBtn = document.getElementById('leave-btn');
        const player1Scene = document.getElementById('player1-scene');
        const player2Scene = document.getElementById('player2-scene');
        const playerRole = document.getElementById('player-role');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const messages = document.getElementById('messages');
        const gameProgress = document.getElementById('game-progress');
        const hintText = document.getElementById('hint-text');
        const currentHint = document.getElementById('current-hint');
        const hintPopup = document.getElementById('hint-popup');
        const hintContent = document.getElementById('hint-content');
        const closeHint = document.getElementById('close-hint');
        const nextRoom = document.getElementById('next-room');

        // Add audio elements for click and success sounds
        const clickSound = new Audio('../graphics/click.mp3');
        const successSound = new Audio('../graphics/success.mp3');

        // Add audio elements for ambient sounds in Detective A's Study
        const ambientSound = new Audio('/static/audio/study_ambient.mp3');
        const creakingSound = new Audio('/static/audio/creaking_door.mp3');
        const footstepsSound = new Audio('/static/audio/footsteps.mp3');

        // Play click sound on button clicks
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', () => {
                clickSound.play();
            });
        });

        // Audio controls logic
        const volumeControl = document.getElementById('volume');
        const muteToggle = document.getElementById('mute-toggle');
        const audioElements = [clickSound, successSound, ambientSound, creakingSound, footstepsSound];

        volumeControl.addEventListener('input', (e) => {
            const volume = e.target.value;
            audioElements.forEach(audio => audio.volume = volume);
        });

        muteToggle.addEventListener('click', () => {
            const isMuted = audioElements[0].muted;
            audioElements.forEach(audio => audio.muted = !isMuted);
            muteToggle.textContent = isMuted ? 'Mute' : 'Unmute';
        });

        // Update scene background assignment for Detective A's "Arbeitszimmer" (Study)
        const style = document.createElement('style');
        style.innerHTML = `
            #player1-scene .scene-bg {
                background: url('/static/images/study_room.png') no-repeat center center;
                background-size: cover;
            }

            #player2-scene .scene-bg {
                background: url('/static/images/secret_library.png') no-repeat center center;
                background-size: cover;
            }
        `;
        document.head.appendChild(style);

        // Initialize game with first stage
        function initializeStage(stageNumber) {
            const stage = gameState.stages[stageNumber - 1];
            gameState.currentStage = stageNumber;
            
            if (gameState.player === 1) {
                hintText.textContent = stage.player1Goal;
            } else {
                hintText.textContent = stage.player2Goal;
            }
            
            currentHint.style.display = 'block';
            updateProgress();
        }

        // Update progress bar
        function updateProgress() {
            const totalStages = gameState.stages.length;
            const progressPercent = ((gameState.currentStage - 1) / totalStages) * 100;
            gameProgress.style.width = `${progressPercent}%`;
        }

        // Stage 1 Interactions — Improve narrative and logic
        function handleObjectInteraction(objectName) {
            const playerClass = gameState.player === 1 ? 'player-1' : 'player-2';
            const playerName = gameState.player === 1 ? 'Detective A' : 'Detective B';
            let message = "";
            let trigger = null;
            let newItem = null;
            let newItemName = "";

            if (objectName === 'chest' && gameState.currentStage === 1) {
                if (gameState.inventory.includes('chest_key')) {
                    message = "You unlock the captain's chest. Inside is Blackwood’s torn diary.";
                    trigger = 'chestOpened';
                    newItem = 'blackwood_diary';
                    newItemName = "Blackwood's Diary";
                } else {
                    message = "The chest is locked. A faded inscription reads: 'Only the uninvited may open.'";
                }
            } else if (objectName === 'palm' && gameState.currentStage === 1) {
                message = "Among shattered glass, you discover a small iron key labeled 'Study'.";
                trigger = 'palmExamined';
                newItem = 'chest_key';
                newItemName = "Study Key";
            }

            addMessage(`${playerName}: [Examined ${objectName}] ${message}`, playerClass);

            if (newItem) {
                addInventoryItem(newItem, newItemName);
            }

            if (trigger) {
                gameState.stages[gameState.currentStage - 1].triggers[trigger] = true;
                checkStageCompletion();
            }
        }

        // Initialize the game
        function startGame() {
            lobby.style.display = 'none';
            gameContainer.style.display = 'grid';
            
            if (gameState.player === 1) {
                playerRole.textContent = "Detective A";
                player1Scene.style.display = 'block';
            } else {
                playerRole.textContent = "Detective B";
                player2Scene.style.display = 'block';
            }
            
            roomCodeDisplay.textContent = gameState.roomId;
            initializeStage(1);
            
            addMessage(`System: You are connected with ${gameState.partnerName}!`);
            addMessage(`System: Work together to solve the puzzles and escape!`);
        }

        // Add Detective A's Study logic and visuals
        const studyObjects = [
            {
                name: "desk",
                description: "A dusty mahogany desk with yellowed papers, an old typewriter, and a diary. A faint glow from an extinguished oil lamp adds to the eerie atmosphere.",
                trigger: "deskExamined",
                newItem: "hidden_key",
                newItemName: "Hidden Key",
                message: "You find a hidden key in the desk's secret compartment."
            },
            {
                name: "portrait",
                description: "A torn portrait of Alistair Blackwood hangs crookedly on the wall. The eyes seem to follow you.",
                trigger: "portraitExamined",
                message: "The portrait's frame has a hidden latch, but it seems to be stuck."
            }
        ];

        function initializeStudyScene() {
            const player1Scene = document.getElementById('player1-scene');
            player1Scene.innerHTML = `
                <div class="scene-bg"></div>
                ${studyObjects.map(obj => `
                    <div class="game-object" style="top: ${Math.random() * 400}px; left: ${Math.random() * 600}px;" data-object="${obj.name}">
                        ${obj.name.charAt(0).toUpperCase() + obj.name.slice(1)}
                    </div>
                `).join('')}
            `;

            // Play ambient sound when the study is initialized
            playAmbientSound();

            document.querySelectorAll('.game-object').forEach(obj => {
                obj.addEventListener('click', function() {
                    const objectName = this.getAttribute('data-object');
                    const objectData = studyObjects.find(o => o.name === objectName);

                    if (objectData) {
                        addMessage(`Detective A: [Examined ${objectName}] ${objectData.description}`);

                        if (objectData.newItem) {
                            addInventoryItem(objectData.newItem, objectData.newItemName);
                            addMessage(`System: ${objectData.message}`);
                        }

                        if (objectData.trigger) {
                            gameState.stages[gameState.currentStage - 1].triggers[objectData.trigger] = true;
                        }

                        // Play creaking sound for specific interactions
                        if (objectName === 'desk' || objectName === 'portrait') {
                            playInteractionSound(creakingSound);
                        } else {
                            playInteractionSound(footstepsSound);
                        }
                    }
                });
            });
        }

        // Call this function when initializing Stage 1 for Detective A
        if (gameState.player === 1 && gameState.currentStage === 1) {
            initializeStudyScene();
        }

        // Event listeners
        createBtn.addEventListener('click', () => {
            const playerName = document.getElementById('player1-name').value.trim();
            if (!playerName) {
                alert("Please enter your name");
                return;
            }
            
            // In a real implementation, this would call a server
            const roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            gameState.player = 1;
            gameState.playerName = playerName;
            gameState.roomId = roomId;
            
            // Simulate partner joining after 1 second
            setTimeout(() => {
                gameState.partnerName = "Captain";
                startGame();
            }, 1000);
            
            alert(`Room created! Share this code with your partner: ${roomId}`);
        });

        joinBtn.addEventListener('click', () => {
            const playerName = document.getElementById('player2-name').value.trim();
            const roomId = document.getElementById('room-id').value.trim().toUpperCase();
            
            if (!playerName) {
                alert("Please enter your name");
                return;
            }
            
            if (!roomId || roomId.length !== 4) {
                alert("Please enter a valid 4-character room code");
                return;
            }
            
            // In a real implementation, this would call a server
            gameState.player = 2;
            gameState.playerName = playerName;
            gameState.roomId = roomId;
            gameState.partnerName = "First Mate";
            
            startGame();
        });

        leaveBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to leave the game?")) {
                gameContainer.style.display = 'none';
                lobby.style.display = 'flex';
                // Reset game state
                gameState.player = null;
                gameState.roomId = null;
                gameState.inventory = [];
                gameState.currentStage = 1;
                document.getElementById('inventory-items').innerHTML = '';
                messages.innerHTML = '';
            }
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                const playerClass = gameState.player === 1 ? 'player-1' : 'player-2';
                const playerName = gameState.player === 1 ? 'First Mate' : 'Captain';
                addMessage(`${playerName}: ${message}`, playerClass);
                chatInput.value = '';
            }
        });

        // Object interaction
        document.querySelectorAll('.game-object').forEach(obj => {
            obj.addEventListener('click', function() {
                const objectName = this.getAttribute('data-object');
                const playerClass = gameState.player === 1 ? 'player-1' : 'player-2';
                const playerName = gameState.player === 1 ? 'Detective A' : 'Detective B';
                
                let message = "";
                let trigger = null;
                let newItem = null;
                let newItemName = "";
                
                // Stage 1 interactions
                if (objectName === 'desk' && gameState.currentStage === 1) {
                    message = "You find a torn diary page mentioning 'Eternalis' and a hidden library.";
                    trigger = 'deskExamined';
                    newItem = 'blackwood_diary';
                    newItemName = "Blackwood's Diary";
                } else if (objectName === 'chalkboard' && gameState.currentStage === 1) {
                    message = "The chalkboard has a formula for 'Eternalis' and a clue: 'The key lies within.'";
                    trigger = 'chalkboardExamined';
                }

                // Stage 2 interactions
                else if (objectName === 'bookshelf' && gameState.currentStage === 2) {
                    message = "You discover a mechanism behind the bookshelf. It slides open, revealing a hidden library.";
                    trigger = 'libraryOpened';
                } else if (objectName === 'safe' && gameState.currentStage === 2) {
                    message = "The safe clicks open, revealing CCTV footage of the mansion from 20 years ago.";
                    trigger = 'safeUnlocked';
                }

                // Stage 3 interactions
                else if (objectName === 'hall' && gameState.currentStage === 3) {
                    message = "You enter the Great Hall. Detective B is waiting. It's time to solve the mystery.";
                    trigger = 'hallReached';
                }

                addMessage(`${playerName}: [Examined ${objectName}] ${message}`, playerClass);

                // Add new item if found
                if (newItem) {
                    addInventoryItem(newItem, newItemName);
                }

                // Update triggers if this action completed one
                if (trigger) {
                    gameState.stages[gameState.currentStage - 1].triggers[trigger] = true;
                    checkStageCompletion();
                }
            });
        });

        // Hint system
        hintBtn.addEventListener('click', showHint);
        closeHint.addEventListener('click', () => {
            hintPopup.style.display = 'none';
        });

        // Close hint when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === hintPopup) {
                hintPopup.style.display = 'none';
            }
        });

        // Add event listener for transitioning to the next room
        document.getElementById('start-next-room').addEventListener('click', () => {
            transitionToNextRoom();
        });

        // Trigger logic for stage completion
        function checkStageCompletion() {
            const currentStage = gameState.stages[gameState.currentStage - 1];
            let allComplete = true;
            for (const trigger in currentStage.triggers) {
                if (!currentStage.triggers[trigger]) {
                    allComplete = false;
                    break;
                }
            }
            if (allComplete) {
                currentStage.completed = true;
                advanceToNextStage();
            }
        }
    </script>
</body>
</html>
